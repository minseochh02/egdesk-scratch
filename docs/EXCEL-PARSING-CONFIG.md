# Excel Parsing Configuration Feature

## Overview

Added flexible Excel parsing to handle real-world file structures that don't follow the standard format. Now supports:
- Headers in any row (not just row 1)
- Skipping total/summary rows at the bottom
- Automatic empty row detection

---

## The Problem

Real-world Excel files often have:
```
Row 1: Company Name                    â† Title
Row 2: Report Date: 2024-02-11         â† Metadata
Row 3: [empty]                         â† Blank spacer
Row 4: Product | Quantity | Price      â† Headers
Row 5: Widget A | 10 | $50             â† Data
Row 6: Widget B | 20 | $40             â† Data
...
Row 50: Total | 500 | $12,000          â† Total (should skip)
Row 51: Generated by System XYZ        â† Footer (should skip)
```

The old parser assumed:
- Row 1 = Headers âŒ
- All rows after = Data âŒ

This would incorrectly import:
- "Company Name" as a column name
- Title/metadata as data rows
- Total row as data

---

## The Solution

### New Parsing Options

```typescript
parseExcel(filePath, {
  headerRow: 4,        // Headers are in row 4
  skipBottomRows: 2,   // Skip last 2 rows (total + footer)
})
```

### How It Works

**Updated Parser Logic:**
1. Read ALL rows first
2. Extract headers from specified row (e.g., row 4)
3. Start data from row after headers (row 5)
4. Stop before bottom rows (row 50 - 2 = row 48)
5. Filter out empty rows automatically

**Result:**
- Correctly identifies headers
- Only imports actual data rows
- Excludes totals and footers
- Handles empty rows gracefully

---

## UI Flow

### New Step 3: Configure Parsing

After selecting a file, users see:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Excel Parsing Options                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ Header Row Number                        â”‚
â”‚ Which row contains the column headers?  â”‚
â”‚ [4____]                                  â”‚
â”‚                                          â”‚
â”‚ Examples:                                â”‚
â”‚ â€¢ Row 1 = Headers in first row (default)â”‚
â”‚ â€¢ Row 2 = Skip title, headers in 2nd    â”‚
â”‚ â€¢ Row 3 = Skip title + blank row        â”‚
â”‚                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                          â”‚
â”‚ Skip Bottom Rows                         â”‚
â”‚ How many rows at bottom to skip?        â”‚
â”‚ [2____]                                  â”‚
â”‚                                          â”‚
â”‚ Examples:                                â”‚
â”‚ â€¢ 0 = Include all rows (default)        â”‚
â”‚ â€¢ 1 = Skip last row (totals)            â”‚
â”‚ â€¢ 2 = Skip last 2 rows (totals+footer)  â”‚
â”‚                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                          â”‚
â”‚ ğŸ“Š Preview Configuration                 â”‚
â”‚ Reading from: Row 4 (headers) â†’ Row 5   â”‚
â”‚ Excluding: Last 2 rows                   â”‚
â”‚                                          â”‚
â”‚         [â† Back]  [Parse Excel â†’]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Implementation

### Backend Changes

**excel-parser.ts:**
```typescript
export async function parseExcelFile(
  filePath: string,
  options?: {
    headerRow?: number;      // Default: 1
    skipRows?: number;       // Default: 0 (reserved for future)
    skipBottomRows?: number; // Default: 0
  }
): Promise<ParsedExcelData>
```

**Key Logic:**
```typescript
// First pass: collect all rows
worksheet.eachRow((row, rowNumber) => {
  allRows.push(values.slice(1));
  totalRows = rowNumber;
});

// Calculate indices
const headerRowIndex = headerRow - 1;        // e.g., 4 - 1 = 3
const dataStartIndex = headerRowIndex + 1;   // e.g., 3 + 1 = 4
const dataEndIndex = totalRows - skipBottomRows; // e.g., 51 - 2 = 49

// Extract headers
headers = allRows[headerRowIndex];

// Extract data rows
for (let i = dataStartIndex; i < dataEndIndex; i++) {
  // Map row to column names
  // Skip empty rows
}
```

### Frontend Changes

**BrowserDownloadsSyncWizard.tsx:**
- Added new step: `'parse-config'`
- State: `headerRow`, `skipBottomRows`
- New render: `renderParseConfig()`
- Passes options to `parseExcel()`

**useUserData.ts:**
- Updated `parseExcel()` signature
- Updated `importExcel()` to accept options
- Updated `syncToExistingTable()` to accept options

### Types

**types.ts:**
```typescript
export interface ExcelImportConfig {
  // ... existing fields ...
  headerRow?: number;
  skipRows?: number;
  skipBottomRows?: number;
}
```

---

## Use Cases

### Case 1: Card Transaction Report
```
Row 1: KB Card Corporation
Row 2: Transaction Report
Row 3: [empty]
Row 4: Date | Merchant | Amount | Category
Row 5-99: [data]
Row 100: Total Transactions: 95
```

**Configuration:**
- Header Row: 4
- Skip Bottom Rows: 1

### Case 2: Sales Report with Multiple Totals
```
Row 1: Q1 Sales Report
Row 2: [headers]
Row 3-50: [data]
Row 51: Subtotal: $50,000
Row 52: Tax: $4,500
Row 53: Grand Total: $54,500
```

**Configuration:**
- Header Row: 2
- Skip Bottom Rows: 3

### Case 3: Standard Excel (No Configuration Needed)
```
Row 1: Name | Email | Phone
Row 2-100: [data]
```

**Configuration:**
- Header Row: 1 (default)
- Skip Bottom Rows: 0 (default)

---

## Benefits

### 1. **Handles Real-World Data**
- No manual Excel cleanup needed
- Works with various file formats
- Supports common business report structures

### 2. **Prevents Data Corruption**
- Excludes total rows from being imported as data
- Prevents metadata from becoming column names
- Filters empty rows automatically

### 3. **User-Friendly**
- Clear visual examples in UI
- Preview shows configuration
- Safe defaults (row 1, no skip)

### 4. **Maintains Data Integrity**
- Only imports actual data
- Correct data types per column
- No manual post-processing required

---

## Examples with Screenshots (Conceptual)

### Example 1: Bank Statement

**Excel File:**
```
Row 1: ABC Bank - Monthly Statement
Row 2: Account: 123-456-7890
Row 3: Period: Jan 1 - Jan 31, 2024
Row 4: [empty]
Row 5: Date | Description | Debit | Credit | Balance
Row 6-105: [100 transactions]
Row 106: Opening Balance: $5,000.00
Row 107: Closing Balance: $6,200.00
```

**Parse Config:**
```
Header Row: 5
Skip Bottom Rows: 2
```

**Result:**
- âœ… 100 transaction rows imported
- âœ… Columns: Date, Description, Debit, Credit, Balance
- âœ… No metadata rows
- âœ… No balance summary rows

### Example 2: Product Inventory

**Excel File:**
```
Row 1: Product | Stock | Unit Price | Total Value
Row 2-50: [49 products]
Row 51: TOTAL | 1,234 | - | $45,678.00
```

**Parse Config:**
```
Header Row: 1
Skip Bottom Rows: 1
```

**Result:**
- âœ… 49 product rows imported
- âœ… No total row
- âœ… Clean data ready for analysis

---

## Testing Checklist

- [ ] Headers in row 1 (default case)
- [ ] Headers in row 2 (skip title)
- [ ] Headers in row 5 (multiple header rows)
- [ ] Skip 0 bottom rows (default)
- [ ] Skip 1 bottom row (totals)
- [ ] Skip 5 bottom rows (multiple footers)
- [ ] Empty rows automatically filtered
- [ ] Works with create new table
- [ ] Works with sync to existing table
- [ ] Configuration preserved during wizard flow
- [ ] Back button works correctly
- [ ] Error handling for invalid row numbers

---

## Future Enhancements

### Potential Improvements

1. **Auto-Detection** â­
   - Automatically detect header row by analyzing content
   - Detect total rows by keyword matching ("Total", "Sum", etc.)

2. **Visual Preview**
   - Show actual Excel rows with highlighting
   - Indicate which rows will be imported
   - Live preview as configuration changes

3. **Skip Top Rows**
   - Currently supported in code, not in UI
   - Add UI option for skipping top rows

4. **Column Range**
   - Specify which columns to import (A-F only)
   - Skip irrelevant columns

5. **Advanced Patterns**
   - Detect merged cells and handle appropriately
   - Support for multiple header rows
   - Handle tables within tables

---

## Migration Notes

### Backward Compatibility

âœ… Fully backward compatible
- Default behavior unchanged (row 1 = headers, include all)
- Existing imports work exactly as before
- New options are optional

### For Users

- No action required for existing workflows
- New files with non-standard structure: use parse config
- Standard files: click through with defaults

---

## Summary

This feature transforms the Excel import from **format-specific** to **structure-flexible**, handling the messy reality of business reports and downloads.

**Key Features:**
- âœ… Headers in any row
- âœ… Skip total/summary rows
- âœ… Auto-filter empty rows
- âœ… User-friendly UI
- âœ… Backward compatible

**Status:** âœ… Complete and ready for testing!
