/**
 * DEMONSTRATION: File Upload Code Generation
 *
 * This test demonstrates the file upload code pattern generated by the browser recorder.
 * It shows both chained file upload (from previous download) and manual file upload patterns.
 *
 * Based on actual generated code from: egdesk-browser-recorder-2026-01-26T05-10-27-219Z.spec.js
 */

const { chromium } = require('playwright-core');
const path = require('path');
const os = require('os');
const fs = require('fs');

(async () => {
  console.log('ðŸŽ¬ File Upload Demo Test');
  console.log('=' .repeat(60));

  // Create downloads directory
  const downloadsPath = path.join(os.homedir(), 'Downloads', 'EGDesk-Browser', 'file-upload-demo');
  if (!fs.existsSync(downloadsPath)) {
    fs.mkdirSync(downloadsPath, { recursive: true });
  }
  console.log('ðŸ“¥ Downloads directory:', downloadsPath);

  // Create temporary profile directory
  const profileDir = fs.mkdtempSync(path.join(os.tmpdir(), 'playwright-profile-'));
  console.log('ðŸ“ Profile directory:', profileDir);

  // Launch browser
  const context = await chromium.launchPersistentContext(profileDir, {
    headless: false,
    channel: 'chrome',
    viewport: null,
    permissions: ['clipboard-read', 'clipboard-write'],
    acceptDownloads: true,
    downloadsPath: downloadsPath,
    args: [
      '--window-size=1200,900',
      '--no-default-browser-check',
      '--disable-blink-features=AutomationControlled',
      '--no-first-run'
    ]
  });

  const page = await context.newPage();

  console.log('\n' + '='.repeat(60));
  console.log('DEMO 1: Chained File Upload Pattern');
  console.log('(File from previous download step)');
  console.log('='.repeat(60) + '\n');

  try {
    // Navigate to a test page (you can use any page with file upload)
    await page.goto('https://the-internet.herokuapp.com/upload');
    await page.waitForTimeout(1000);

    console.log('âœ“ Navigated to test page with file upload');

    // PATTERN 1: Chained File Upload
    // This demonstrates uploading a file that was downloaded in a previous step
    {
      console.log('\n--- Chained File Upload Code Pattern ---\n');

      // In a real recording, this would reference a file from previous download
      // For demo purposes, we'll create a test file
      const testFileName = 'demo-chained-file.txt';
      const uploadFilePath = path.join(downloadsPath, testFileName);

      // Create a demo file (simulating a previous download)
      fs.writeFileSync(uploadFilePath, 'This file was "downloaded" in a previous step.\nNow being uploaded in this step.');
      console.log('ðŸ“„ Created demo file (simulating previous download):', testFileName);

      console.log('\n// Generated code for chained file upload:');
      console.log('// -----------------------------------------');
      console.log('// Upload file from previous chain step');
      console.log(`const uploadFilePath = path.join(downloadsPath, '${testFileName}');`);
      console.log(`console.log('ðŸ“¤ Uploading file from chain:', uploadFilePath);`);
      console.log('');
      console.log('// IMPORTANT: Set up file chooser handler BEFORE clicking');
      console.log('page.once(\'filechooser\', async (fileChooser) => {');
      console.log('  console.log(\'ðŸ” File chooser detected, handling...\');');
      console.log('  await fileChooser.setFiles(uploadFilePath);');
      console.log('  console.log(\'âœ… File uploaded:\', uploadFilePath);');
      console.log('});');
      console.log('');
      console.log('// Small delay to ensure listener is registered');
      console.log('await page.waitForTimeout(100);');
      console.log('');
      console.log('// Click the file input to trigger file chooser');
      console.log('await page.locator(\'#file-upload\').click({ timeout: 10000 });');
      console.log('');
      console.log('// Wait a moment for file chooser to be handled');
      console.log('await page.waitForTimeout(1000);');
      console.log('// -----------------------------------------\n');

      // Actually execute the pattern
      console.log('ðŸ“¤ Uploading file from chain:', uploadFilePath);

      // IMPORTANT: Set up file chooser handler BEFORE clicking
      page.once('filechooser', async (fileChooser) => {
        console.log('ðŸ” File chooser detected, handling...');
        await fileChooser.setFiles(uploadFilePath);
        console.log('âœ… File uploaded:', uploadFilePath);
      });

      // Small delay to ensure listener is registered
      await page.waitForTimeout(100);

      // Click the file input to trigger file chooser
      await page.locator('#file-upload').click({ timeout: 10000 });

      // Wait a moment for file chooser to be handled
      await page.waitForTimeout(1000);

      // Verify the file was selected
      const selectedFile = await page.locator('#file-upload').inputValue();
      console.log('âœ“ File selected in input:', selectedFile.includes(testFileName) ? testFileName : selectedFile);
    }

    await page.waitForTimeout(2000);

    console.log('\n' + '='.repeat(60));
    console.log('DEMO 2: Manual File Upload Pattern');
    console.log('(User needs to specify file path)');
    console.log('='.repeat(60) + '\n');

    // Reload page for second demo
    await page.reload();
    await page.waitForTimeout(1000);

    // PATTERN 2: Manual File Upload
    // This demonstrates uploading a file where path must be specified by user
    {
      console.log('\n--- Manual File Upload Code Pattern ---\n');

      console.log('// Generated code for manual file upload:');
      console.log('// -----------------------------------------');
      console.log('// Manual file upload - you\'ll need to specify the file path');
      console.log('// Replace \'/path/to/your/file\' with the actual file path');
      console.log('const uploadFilePath = \'/path/to/your/file\'; // TODO: Update this path');
      console.log(`console.log('ðŸ“¤ Uploading file:', uploadFilePath);`);
      console.log('');
      console.log('// IMPORTANT: Set up file chooser handler BEFORE clicking');
      console.log('page.once(\'filechooser\', async (fileChooser) => {');
      console.log('  console.log(\'ðŸ” File chooser detected, handling...\');');
      console.log('  await fileChooser.setFiles(uploadFilePath);');
      console.log('  console.log(\'âœ… File uploaded\');');
      console.log('});');
      console.log('');
      console.log('// Small delay to ensure listener is registered');
      console.log('await page.waitForTimeout(100);');
      console.log('');
      console.log('// Click the file input to trigger file chooser');
      console.log('await page.locator(\'#file-upload\').click({ timeout: 10000 });');
      console.log('');
      console.log('// Wait a moment for file chooser to be handled');
      console.log('await page.waitForTimeout(1000);');
      console.log('// -----------------------------------------\n');

      // For demo, we'll create a manual file
      const manualFileName = 'demo-manual-file.txt';
      const uploadFilePath = path.join(downloadsPath, manualFileName);
      fs.writeFileSync(uploadFilePath, 'This is a manually specified file.\nUser must update the path in generated code.');

      console.log('ðŸ“¤ Uploading file:', uploadFilePath);
      console.log('â„¹ï¸  In generated code, this would be: const uploadFilePath = \'/path/to/your/file\';');

      // IMPORTANT: Set up file chooser handler BEFORE clicking
      page.once('filechooser', async (fileChooser) => {
        console.log('ðŸ” File chooser detected, handling...');
        await fileChooser.setFiles(uploadFilePath);
        console.log('âœ… File uploaded');
      });

      // Small delay to ensure listener is registered
      await page.waitForTimeout(100);

      // Click the file input to trigger file chooser
      await page.locator('#file-upload').click({ timeout: 10000 });

      // Wait a moment for file chooser to be handled
      await page.waitForTimeout(1000);

      // Verify the file was selected
      const selectedFile = await page.locator('#file-upload').inputValue();
      console.log('âœ“ File selected in input:', selectedFile.includes(manualFileName) ? manualFileName : selectedFile);
    }

    console.log('\n' + '='.repeat(60));
    console.log('KEY IMPLEMENTATION POINTS');
    console.log('='.repeat(60));
    console.log('1. File chooser listener MUST be set up BEFORE clicking file input');
    console.log('2. Use page.once() to handle the file chooser event');
    console.log('3. 100ms delay ensures listener is registered before click');
    console.log('4. 1000ms delay after click allows file chooser to complete');
    console.log('5. Chained files use path.join(downloadsPath, filename)');
    console.log('6. Manual files use placeholder path with TODO comment');
    console.log('7. The click that triggers file chooser is NOT duplicated');
    console.log('='.repeat(60));

    await page.waitForTimeout(3000);

  } catch (error) {
    console.error('\nâŒ Error during demo:', error.message);
    throw error;
  } finally {
    console.log('\nðŸ§¹ Cleaning up...');
    await context.close();

    // Clean up profile directory
    try {
      fs.rmSync(profileDir, { recursive: true, force: true });
      console.log('âœ“ Cleaned up profile directory');
    } catch (e) {
      console.warn('âš ï¸  Failed to clean up profile directory:', e.message);
    }

    console.log('âœ“ Demo files remain in:', downloadsPath);
    console.log('âœ¨ Demo complete!\n');
  }
})().catch(error => {
  console.error('\nðŸ’¥ Fatal error:', error);
  process.exit(1);
});
